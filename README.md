# ğŸ´ Anki Cloud Sync Server

åœ¨ Railway äº‘ç«¯éƒ¨ç½² Ankiï¼Œæ”¯æŒ AI æœºå™¨äººå’Œç”¨æˆ·å¤šç«¯åŒæ­¥ã€‚

## ğŸ¯ æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Railway äº‘ç«¯ (24/7)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Anki Desktop        â”‚        â”‚
â”‚  â”‚ + AnkiConnect API   â”‚        â”‚
â”‚  â”‚ + è‡ªåŠ¨åŒæ­¥è„šæœ¬       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         â†• HTTP API              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    æœºå™¨äººè™šæ‹Ÿæœº (è°ƒç”¨ API)
           â†“
    Railway Anki â† â†’ AnkiWeb å®˜æ–¹æœåŠ¡å™¨ â† â†’ ç”¨æˆ· Anki
```

## âœ¨ ç‰¹æ€§

- âœ… AnkiConnect REST API (8765 ç«¯å£)
- âœ… è‡ªåŠ¨åŒæ­¥åˆ° AnkiWeb å®˜æ–¹æœåŠ¡å™¨
- âœ… 24/7 äº‘ç«¯è¿è¡Œ
- âœ… æ”¯æŒæœºå™¨äººè¿œç¨‹æ·»åŠ å¡ç‰‡
- âœ… å¤šç«¯æ•°æ®ä¸€è‡´

## ğŸš€ éƒ¨ç½²åˆ° Railway

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡å·¥ä½œ

1. **åˆ›å»º Railway è´¦æˆ·**
   - è®¿é—® https://railway.app
   - ä½¿ç”¨ GitHub è´¦æˆ·ç™»å½•

2. **å‡†å¤‡ AnkiWeb è´¦æˆ·**
   - è®¿é—® https://ankiweb.net/account/register
   - è®°ä½ç”¨æˆ·åå’Œå¯†ç ï¼ˆç”¨äºè‡ªåŠ¨åŒæ­¥ï¼‰

### ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²

#### æ–¹æ³• 1ï¼šä¸€é”®éƒ¨ç½²ï¼ˆæ¨èï¼‰

1. Fork æœ¬ä»“åº“åˆ°ä½ çš„ GitHub è´¦æˆ·

2. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®éƒ¨ç½²ï¼š

   [![Deploy on Railway](https://railway.app/button.svg)](https://railway.app/new/template)

3. æˆ–æ‰‹åŠ¨éƒ¨ç½²ï¼š
   - ç™»å½• Railway Dashboard
   - ç‚¹å‡» "New Project" â†’ "Deploy from GitHub repo"
   - é€‰æ‹© Fork çš„ä»“åº“
   - Railway ä¼šè‡ªåŠ¨æ£€æµ‹ `Dockerfile` å¹¶æ„å»º

#### æ–¹æ³• 2ï¼šä½¿ç”¨ Railway CLI

```bash
# å®‰è£… Railway CLI
npm i -g @railway/cli

# ç™»å½•
railway login

# åˆå§‹åŒ–é¡¹ç›®
railway init

# éƒ¨ç½²
railway up
```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

åœ¨ Railway Dashboard çš„ "Variables" æ ‡ç­¾é¡µæ·»åŠ ï¼š

| å˜é‡å | å€¼ | è¯´æ˜ |
|--------|---|------|
| `ANKIWEB_USERNAME` | ä½ çš„ AnkiWeb ç”¨æˆ·å | å¿…éœ€ |
| `ANKIWEB_PASSWORD` | ä½ çš„ AnkiWeb å¯†ç  | å¿…éœ€ |
| `SYNC_INTERVAL` | `300` | å¯é€‰ï¼ŒåŒæ­¥é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 5 åˆ†é’Ÿ |

âš ï¸ **é‡è¦**: è®¾ç½®ç¯å¢ƒå˜é‡åéœ€è¦é‡æ–°éƒ¨ç½²ï¼

### ç¬¬å››æ­¥ï¼šè·å–æœåŠ¡ URL

1. éƒ¨ç½²å®Œæˆåï¼Œåœ¨ "Settings" â†’ "Domains" ç”Ÿæˆå…¬å¼€åŸŸå
2. ä½ ä¼šè·å¾—ç±»ä¼¼ `https://anki-server-production-xxxx.up.railway.app` çš„ URL
3. AnkiConnect API åœ°å€ï¼š`https://ä½ çš„åŸŸå.railway.app`ï¼ˆé»˜è®¤å·²æ˜ å°„ 8765 ç«¯å£ï¼‰

### ç¬¬äº”æ­¥ï¼šæµ‹è¯•

```bash
# æµ‹è¯•è¿æ¥
curl -X POST https://ä½ çš„åŸŸå.railway.app \
  -H "Content-Type: application/json" \
  -d '{"action": "version", "version": 6}'

# é¢„æœŸå“åº”
{"result": 6, "error": null}
```

## ğŸ“š æœºå™¨äººä½¿ç”¨æŒ‡å—

æŸ¥çœ‹ [API_GUIDE.md](./API_GUIDE.md) è·å–å®Œæ•´çš„ API ä½¿ç”¨æ–‡æ¡£ã€‚

### å¿«é€Ÿå¼€å§‹

```python
import requests

ANKI_URL = "https://ä½ çš„åŸŸå.railway.app"

# æ·»åŠ å¡ç‰‡
def add_card(front, back, deck="Default"):
    payload = {
        "action": "addNote",
        "version": 6,
        "params": {
            "note": {
                "deckName": deck,
                "modelName": "Basic",
                "fields": {"Front": front, "Back": back},
                "tags": ["æœºå™¨äººæ·»åŠ "]
            }
        }
    }
    response = requests.post(ANKI_URL, json=payload)
    return response.json()

# ä½¿ç”¨
result = add_card(
    front="ä»€ä¹ˆæ˜¯ Dockerï¼Ÿ",
    back="Docker æ˜¯ä¸€ä¸ªå®¹å™¨åŒ–å¹³å°"
)
print(f"å¡ç‰‡ ID: {result['result']}")
```

## ğŸ”„ åŒæ­¥æœºåˆ¶

### è‡ªåŠ¨åŒæ­¥

æœåŠ¡å™¨ä¼šå®šæœŸï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰è‡ªåŠ¨å°†æ•°æ®åŒæ­¥åˆ° AnkiWeb å®˜æ–¹æœåŠ¡å™¨ï¼š

- æœºå™¨äººæ·»åŠ å¡ç‰‡ â†’ Railway Anki
- Railway Anki â†’ è‡ªåŠ¨æ¨é€ â†’ AnkiWeb å®˜æ–¹
- ç”¨æˆ· Anki å®¢æˆ·ç«¯ â†’ ä»å®˜æ–¹æœåŠ¡å™¨æ‹‰å–

### æ‰‹åŠ¨è§¦å‘åŒæ­¥

```bash
curl -X POST https://ä½ çš„åŸŸå.railway.app \
  -d '{"action": "sync", "version": 6}'
```

### é…ç½®åŒæ­¥é—´éš”

ä¿®æ”¹ç¯å¢ƒå˜é‡ `SYNC_INTERVAL`ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼š
- `60` = æ¯åˆ†é’ŸåŒæ­¥
- `300` = æ¯ 5 åˆ†é’Ÿï¼ˆé»˜è®¤ï¼‰
- `600` = æ¯ 10 åˆ†é’Ÿ

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### æŸ¥çœ‹æ—¥å¿—

åœ¨ Railway Dashboard â†’ "Deployments" â†’ é€‰æ‹©æœ€æ–°éƒ¨ç½² â†’ "View Logs"

æ—¥å¿—ç¤ºä¾‹ï¼š
```
ğŸš€ å¯åŠ¨ Anki åŒæ­¥æœåŠ¡å™¨
âœ… æ£€æµ‹åˆ° AnkiWeb å‡­æ®
ğŸ–¥ï¸  å¯åŠ¨è™šæ‹Ÿæ˜¾ç¤º (Xvfb)...
âœ… AnkiConnect å·²å®‰è£…
ğŸ´ å¯åŠ¨ Anki...
âœ… AnkiConnect å·²å°±ç»ªï¼
ğŸ”„ å¯åŠ¨è‡ªåŠ¨åŒæ­¥ (é—´éš”: 300ç§’)...
âœ… Anki æœåŠ¡å™¨å·²å¯åŠ¨ï¼
```

### å¥åº·æ£€æŸ¥

åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š

```python
import requests

def check_anki_health():
    try:
        response = requests.post(
            "https://ä½ çš„åŸŸå.railway.app",
            json={"action": "version", "version": 6},
            timeout=10
        )
        return response.json().get("result") == 6
    except:
        return False

if check_anki_health():
    print("âœ… Anki æœåŠ¡æ­£å¸¸")
else:
    print("âŒ Anki æœåŠ¡å¼‚å¸¸")
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: éƒ¨ç½²å¤±è´¥

**ç—‡çŠ¶**: Railway æ„å»ºå¤±è´¥

**è§£å†³**:
1. æ£€æŸ¥ Dockerfile è¯­æ³•
2. æŸ¥çœ‹æ„å»ºæ—¥å¿—æŸ¥æ‰¾é”™è¯¯
3. ç¡®ä¿åŸºç¡€é•œåƒå¯è®¿é—®

### é—®é¢˜ 2: æ— æ³•è¿æ¥ API

**ç—‡çŠ¶**: curl è¯·æ±‚è¶…æ—¶æˆ– 502 é”™è¯¯

**è§£å†³**:
1. æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œï¼ˆRailway Dashboard â†’ Logsï¼‰
2. ç¡®è®¤åŸŸåæ˜¯å¦æ­£ç¡®ç”Ÿæˆ
3. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
4. æŸ¥çœ‹å®¹å™¨æ—¥å¿—ï¼š`railway logs`

### é—®é¢˜ 3: è‡ªåŠ¨åŒæ­¥å¤±è´¥

**ç—‡çŠ¶**: æ—¥å¿—æ˜¾ç¤ºåŒæ­¥é”™è¯¯

**è§£å†³**:
1. æ£€æŸ¥ `ANKIWEB_USERNAME` å’Œ `ANKIWEB_PASSWORD` æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤ AnkiWeb è´¦æˆ·å¯ä»¥æ­£å¸¸ç™»å½•
3. æŸ¥çœ‹æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
4. æ‰‹åŠ¨è§¦å‘åŒæ­¥æµ‹è¯•ï¼š
   ```bash
   curl -X POST https://ä½ çš„åŸŸå.railway.app -d '{"action":"sync","version":6}'
   ```

### é—®é¢˜ 4: å¡ç‰‡æœªåŒæ­¥åˆ°ç”¨æˆ·

**ç—‡çŠ¶**: æœºå™¨äººæ·»åŠ äº†å¡ç‰‡ï¼Œä½†ç”¨æˆ·çœ‹ä¸åˆ°

**è§£å†³**:
1. ç­‰å¾…è‡ªåŠ¨åŒæ­¥å®Œæˆï¼ˆæœ€å¤š 5 åˆ†é’Ÿï¼‰
2. æˆ–æ‰‹åŠ¨è§¦å‘åŒæ­¥
3. ç¡®ä¿ç”¨æˆ·ä½¿ç”¨çš„æ˜¯**ç›¸åŒçš„ AnkiWeb è´¦æˆ·**
4. ç”¨æˆ·åœ¨ Anki å®¢æˆ·ç«¯ç‚¹å‡»"åŒæ­¥"æŒ‰é’®

### é—®é¢˜ 5: Railway å®¹å™¨é‡å¯

**ç—‡çŠ¶**: æœåŠ¡é¢‘ç¹é‡å¯

**è§£å†³**:
1. æ£€æŸ¥å†…å­˜ä½¿ç”¨ï¼ˆRailway å…è´¹è®¡åˆ’æœ‰é™åˆ¶ï¼‰
2. æŸ¥çœ‹æ—¥å¿—ä¸­çš„å´©æºƒä¿¡æ¯
3. è€ƒè™‘å‡çº§ Railway è®¡åˆ’

## ğŸ’° æˆæœ¬ä¼°ç®—

### Railway å…è´¹è®¡åˆ’
- âœ… 500 å°æ—¶/æœˆï¼ˆçº¦ 20 å¤©ï¼‰
- âœ… 512MB RAM
- âœ… 1GB ç£ç›˜
- âš ï¸ é€‚åˆä¸ªäººä½¿ç”¨ + æœºå™¨äºº

### Railway Hobby è®¡åˆ’ï¼ˆ$5/æœˆï¼‰
- âœ… æ— é™è¿è¡Œæ—¶é—´
- âœ… 8GB RAM
- âœ… 100GB ç£ç›˜
- âœ… é€‚åˆç”Ÿäº§ç¯å¢ƒ

**å»ºè®®**: ä¸ªäººä½¿ç”¨å…è´¹è®¡åˆ’è¶³å¤Ÿï¼Œå¦‚éœ€ 24/7 è¿è¡Œå»ºè®®å‡çº§ã€‚

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä¿æŠ¤ç¯å¢ƒå˜é‡**
   - ä¸è¦å°† AnkiWeb å¯†ç æäº¤åˆ° Git
   - ä½¿ç”¨ Railway çš„ç¯å¢ƒå˜é‡åŠŸèƒ½

2. **é™åˆ¶ API è®¿é—®**ï¼ˆå¯é€‰ï¼‰
   - ä¿®æ”¹ `install_ankiconnect.sh` ä¸­çš„ `webCorsOriginList`
   - åªå…è®¸æœºå™¨äºº IP è®¿é—®

3. **å®šæœŸæ›´æ–°**
   - å®šæœŸæ‹‰å–æœ€æ–°ä»£ç 
   - æ›´æ–° Anki ç‰ˆæœ¬ï¼ˆä¿®æ”¹ Dockerfileï¼‰

## ğŸ› ï¸ æœ¬åœ°å¼€å‘

### ä½¿ç”¨ Docker æœ¬åœ°æµ‹è¯•

```bash
# æ„å»ºé•œåƒ
docker build -t anki-server .

# è¿è¡Œå®¹å™¨
docker run -d \
  -p 8765:8765 \
  -e ANKIWEB_USERNAME=ä½ çš„ç”¨æˆ·å \
  -e ANKIWEB_PASSWORD=ä½ çš„å¯†ç  \
  -e SYNC_INTERVAL=300 \
  anki-server

# æµ‹è¯•
curl -X POST http://localhost:8765 \
  -d '{"action":"version","version":6}'
```

### æŸ¥çœ‹å®¹å™¨æ—¥å¿—

```bash
docker ps  # è·å–å®¹å™¨ ID
docker logs -f <å®¹å™¨ID>
```

## ğŸ“– æŠ€æœ¯æ ˆ

- **Anki**: 24.11 (Linux Qt6 ç‰ˆæœ¬)
- **AnkiConnect**: æœ€æ–°ç‰ˆ
- **Xvfb**: è™šæ‹Ÿæ˜¾ç¤ºæœåŠ¡å™¨
- **Python 3**: è‡ªåŠ¨åŒæ­¥è„šæœ¬
- **Debian**: åŸºç¡€é•œåƒ

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“„ è®¸å¯è¯

MIT License

## ğŸ”— ç›¸å…³é“¾æ¥

- [AnkiConnect å®˜æ–¹æ–‡æ¡£](https://foosoft.net/projects/anki-connect/)
- [Anki å®˜ç½‘](https://apps.ankiweb.net/)
- [Railway æ–‡æ¡£](https://docs.railway.app/)
- [æœºå™¨äºº API æŒ‡å—](./API_GUIDE.md)

## â“ FAQ

### Q: å¯ä»¥åŒæ—¶ä½¿ç”¨å¤šä¸ª AnkiWeb è´¦æˆ·å—ï¼Ÿ
A: ä¸å¯ä»¥ï¼Œä¸€ä¸ªéƒ¨ç½²åªèƒ½ç»‘å®šä¸€ä¸ª AnkiWeb è´¦æˆ·ã€‚å¦‚éœ€å¤šè´¦æˆ·ï¼Œéƒ¨ç½²å¤šä¸ªå®ä¾‹ã€‚

### Q: æœºå™¨äººæ·»åŠ çš„å¡ç‰‡ä¼šç«‹å³åŒæ­¥å—ï¼Ÿ
A: é»˜è®¤æœ€å¤šç­‰å¾… 5 åˆ†é’Ÿï¼ˆè‡ªåŠ¨åŒæ­¥é—´éš”ï¼‰ï¼Œæˆ–è°ƒç”¨ `sync` API ç«‹å³åŒæ­¥ã€‚

### Q: æ•°æ®ä¼šä¸¢å¤±å—ï¼Ÿ
A: Railway å®¹å™¨é‡å¯ä¼šä¿ç•™ `/root/.local/share/Anki2` ç›®å½•ï¼Œä½†å»ºè®®å®šæœŸåŒæ­¥åˆ° AnkiWeb å®˜æ–¹æœåŠ¡å™¨ä½œä¸ºå¤‡ä»½ã€‚

### Q: å¯ä»¥æ·»åŠ éŸ³é¢‘/å›¾ç‰‡å—ï¼Ÿ
A: å¯ä»¥ï¼å‚è€ƒ [API_GUIDE.md](./API_GUIDE.md) çš„ `storeMediaFile` æ“ä½œã€‚

### Q: æ”¯æŒä¸­æ–‡å—ï¼Ÿ
A: å®Œå…¨æ”¯æŒï¼ŒAnki åŸç”Ÿæ”¯æŒ UTF-8ã€‚

---

**éƒ¨ç½²é‡åˆ°é—®é¢˜ï¼Ÿ** æŸ¥çœ‹ [Issues](https://github.com/ä½ çš„ç”¨æˆ·å/Anki_Server/issues) æˆ–æäº¤æ–°é—®é¢˜ã€‚

**ç¥ä½¿ç”¨æ„‰å¿«ï¼** ğŸ´âœ¨
